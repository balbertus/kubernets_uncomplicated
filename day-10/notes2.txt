day-10 - Observability - Prometheus

Service Monitor

Creating a Service Monitor

1. Create an Application (as nginx)
2. Use Ngnix-Exporter
3. Create a pod to simulae some payload.
4. First of all Create a configMap

> ConfigMap to expose Nginx metrics 
	route - /nginx_status
		/metrics

Manifest: nginx-config.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf:
    server {
      listen 80;
      location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
      }
      location /metrics {
        stub_status on;
        access_log off;
      }
    }

Apply 
$ kubectl apply -f nginx-config.yaml
configmap/nginx-config created
balbertus@HP-ProBook-440-G1:~/PICK/kubernets_uncomplicated/day-10$ kubectl get configmaps
NAME               DATA   AGE
kube-root-ca.crt   1      3d18h
nginx-config       1      3s
balbertus@HP-ProBook-440-G1:~/PICK/kubernets_uncomplicated/day-10$ kubectl get configmaps nginx-config -o yaml
apiVersion: v1
data:
  nginx.conf: server { listen 80; location / { root /usr/share/nginx/html; index index.html
    index.htm; } location /metrics { stub_status on; access_log off; } }
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"nginx.conf":"server { listen 80; location / { root /usr/share/nginx/html; index index.html index.htm; } location /metrics { stub_status on; access_log off; } }"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"nginx-config","namespace":"default"}}
  creationTimestamp: "2026-01-02T12:50:24Z"
  name: nginx-config
  namespace: default
  resourceVersion: "367175"
  uid: d0a3faee-a95b-43e1-9d68-c2230a4cf007


Next goes to create an nginx deployment

Manifest
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-server
spec: # resource specification
  selector: # Selector which SelectorMonitor will be find to be used as service monitoring
    matchLabels: #Label to be used on monitoring by ServiceMonitor
      app: nginx
  replicas: 3
  template: # will be used to create pods
    metadata:
      labels:
        app: nginx
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9113'
    spec: #Template specification
      containers:
        - name: nginx # container name that will be created on the Pod.
          image: nginx 
          ports:
            - containerPort: 80
              name: http
          volumeMounts: # volume that will be mounted on container
            - name: nginx-config # name of volume
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf 
        - name: nginx-exporter
          image: 'nginx/nginx-prometheus-exporter:0.11.0' #image specific to nginx exporter
          args: 
            - '-nginx.scrape-uri=http://localhost/metrics' # argument to define URI scrapping   
          resources:
            limits:
              memory: 128Mi
              cpu: 0.3
          ports:
            - containerPort: 9113 #port to be exposed
              name: metrics
      volumes:
        - configMap:
            defaultMode: 420 #default mode of volume
            name: nginx-config
          name: nginx-config     

$ kubectl apply -f nginx-deployment.yaml 
deployment.apps/nginx-server created

$ kubectl get deployments
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx              1/1     1            1           10d
nginx-deployment   3/3     3            3           114d
nginx-server       3/3     3            3           14s

$ kubectl get pods
NAME                               READY   STATUS    RESTARTS        AGE
nginx                              1/1     Running   2 (5h4m ago)    3d22h
nginx-7ccccd94f7-t4bg8             1/1     Running   3 (5h4m ago)    10d
nginx-deployment-6bf86444b-4qfhd   1/1     Running   19 (5h4m ago)   114d
nginx-deployment-6bf86444b-9vzns   1/1     Running   19 (5h4m ago)   114d
nginx-deployment-6bf86444b-vw6x6   1/1     Running   19 (5h4m ago)   114d
nginx-server-6684997d86-dwf9t      2/2     Running   0               91s
nginx-server-6684997d86-lrgkc      2/2     Running   0               91s
nginx-server-6684997d86-mz9qs      2/2     Running   0               91s

on describe output see
$ kubectl describe pod nginx-server-6684997d86-dwf9t
Name:             nginx-server-6684997d86-dwf9t
Namespace:        default
Priority:         0
Service Account:  default
Node:             kind-control-plane/172.18.0.2
Start Time:       Fri, 02 Jan 2026 13:19:00 -0300
Labels:           app=nginx
                  pod-template-hash=6684997d86
Annotations:      prometheus.io/port: 9113
                  prometheus.io/scrape: true
Status:           Running
IP:               10.244.0.12
IPs:
  IP:           10.244.0.12
Controlled By:  ReplicaSet/nginx-server-6684997d86
Containers:
  nginx:
    Container ID:   containerd://c9189e1460394d0933375461cd33d0a2a9748da758d593f87f5b4b57a0be88cf
    Image:          nginx
    Image ID:       docker.io/library/nginx@sha256:ca871a86d45a3ec6864dc45f014b11fe626145569ef0e74deaffc95a3b15b430
    Port:           80/TCP (http)
    Host Port:      0/TCP (http)
    State:          Running
      Started:      Fri, 02 Jan 2026 13:19:05 -0300
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /etc/nginx/conf.d/default.conf from nginx-config (rw,path="nginx.conf")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zzlkv (ro)
  nginx-exporter:
    Container ID:  containerd://23008d6e3781f2cee30400f4078c4f59d45d7efff7b88a9de5ee22f8b959df23
    Image:         nginx/nginx-prometheus-exporter:0.11.0
    Image ID:      docker.io/nginx/nginx-prometheus-exporter@sha256:131c2c2963296bbae7e9fcb52f77a1202f1d87d5d85e8e6cd7bcbccad799bc01
    Port:          9113/TCP (metrics)
    Host Port:     0/TCP (metrics)
    Args:
      -nginx.scrape-uri=http://localhost/metrics
    State:          Running
      Started:      Fri, 02 Jan 2026 13:19:13 -0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     300m
      memory:  128Mi
    Requests:
      cpu:        300m
      memory:     128Mi
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zzlkv (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  nginx-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      nginx-config
    Optional:  false
  kube-api-access-zzlkv:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    Optional:                false
    DownwardAPI:             true
QoS Class:                   Burstable
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m11s  default-scheduler  Successfully assigned default/nginx-server-6684997d86-dwf9t to kind-control-plane
  Normal  Pulling    2m10s  kubelet            Pulling image "nginx"
  Normal  Pulled     2m6s   kubelet            Successfully pulled image "nginx" in 1.436s (4.505s including waiting). Image size: 59797235 bytes.
  Normal  Created    2m6s   kubelet            Created container: nginx
  Normal  Started    2m6s   kubelet            Started container nginx
  Normal  Pulling    2m6s   kubelet            Pulling image "nginx/nginx-prometheus-exporter:0.11.0"
  Normal  Pulled     118s   kubelet            Successfully pulled image "nginx/nginx-prometheus-exporter:0.11.0" in 1.433s (7.241s including waiting). Image size: 3719253 bytes.
  Normal  Created    118s   kubelet            Created container: nginx-exporter
  Normal  Started    118s   kubelet            Started container nginx-exporter

Next ! 
Service to expose our deployment.

Manifest:
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  labels:
    app: nginx
spec:
  selector: #Selector to identify pods/deployment which this service will expose
    app: nginx
  ports:
  - port: 9113
    name: metrics

$kubectl apply -f nginx-service.yaml 
service/nginx-svc created

$ kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP          114d
nginx        ClusterIP   10.96.167.120   <none>        80/TCP,443/TCP   3d22h
nginx-svc    ClusterIP   10.96.102.230   <none>        9113/TCP         8s

Prove

 kubectl exec -ti  nginx-server-6684997d86-dwf9t -c nginx -- bash
root@nginx-server-6684997d86-dwf9t:/# curl localhost
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
root@nginx-server-6684997d86-dwf9t:/# curl localhost/metrics
Active connections: 1 
server accepts handled requests
 3 3 3 
Reading: 0 Writing: 1 Waiting: 0 
root@nginx-server-6684997d86-dwf9t:/# curl localhost:9113   
<!DOCTYPE html>
			<title>NGINX Exporter</title>
			<h1>NGINX Exporter</h1>
			<p><a href="/metrics">Metrics</a></p>root@nginx-server-6684997d86-dwf9t:/# 
root@nginx-server-6684997d86-dwf9t:/# 
root@nginx-server-6684997d86-dwf9t:/# 
root@nginx-server-6684997d86-dwf9t:/# 
root@nginx-server-6684997d86-dwf9t:/# 
root@nginx-server-6684997d86-dwf9t:/# curl localhost:9113/metrics
# HELP nginx_connections_accepted Accepted client connections
# TYPE nginx_connections_accepted counter
nginx_connections_accepted 4
# HELP nginx_connections_active Active client connections
# TYPE nginx_connections_active gauge
nginx_connections_active 1
# HELP nginx_connections_handled Handled client connections
# TYPE nginx_connections_handled counter
nginx_connections_handled 4
# HELP nginx_connections_reading Connections where NGINX is reading the request header
# TYPE nginx_connections_reading gauge
nginx_connections_reading 0
# HELP nginx_connections_waiting Idle client connections
# TYPE nginx_connections_waiting gauge
nginx_connections_waiting 0
# HELP nginx_connections_writing Connections where NGINX is writing the response back to the client
# TYPE nginx_connections_writing gauge
nginx_connections_writing 1
# HELP nginx_http_requests_total Total http requests
# TYPE nginx_http_requests_total counter
nginx_http_requests_total 4
# HELP nginx_up Status of the last metric scrape
# TYPE nginx_up gauge
nginx_up 1
# HELP nginxexporter_build_info Exporter build information
# TYPE nginxexporter_build_info gauge
nginxexporter_build_info{arch="linux/amd64",commit="e4a6810d4f0b776f7fde37fea1d84e4c7284b72a",date="2022-09-07T21:09:51Z",dirty="false",go="go1.19",version="0.11.0"} 1

>> POD MONITOR <<

Usefull when you cannot use a ServiceMonitor

Manifest

apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx-pod
spec: #Template specification
  containers:
  - name: nginx-container # container name that will be created on the Pod.
    image: nginx 
    ports:
      - containerPort: 80
        name: http
    volumeMounts: # volume that will be mounted on container
      - name: nginx-config # name of volume
        mountPath: /etc/nginx/conf.d/default.conf
        subPath: nginx.conf 
  - name: nginx-exporter
    image: 'nginx/nginx-prometheus-exporter:0.11.0' #image specific to nginx exporter
    args: 
      - '-nginx.scrape-uri=http://localhost/metrics' # argument to define URI scrapping   
    resources:
      limits:
        memory: 128Mi
        cpu: 0.3
    ports:
      - containerPort: 9113 #port to be exposed
        name: metrics
  volumes:
    - configMap:
        defaultMode: 420 #default mode of volume
        name: nginx-config
      name: nginx-config

Pod Monitor

Manifest
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: nginx-podmonitor
  labels:
    app: nginx-pod
spec:
  namespaceSelector: #to select namespaces to be monitored
    matchNames:
      - default
  selector:
    matchLabels:
      app: nginx-pod
  podMetricsEndpoints: # to define which Endpoints will be monitored.
    - interval: 10s
      path: /metrics
      targetPort: 9113



